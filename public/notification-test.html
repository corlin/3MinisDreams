<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web通知测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; }
        .warning { background-color: #fff3cd; color: #856404; }
        .error { background-color: #f8d7da; color: #721c24; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔔 Web通知功能测试</h1>
        
        <div id="status" class="status warning">
            正在检查通知支持...
        </div>
        
        <div>
            <button id="requestPermission" onclick="requestPermission()">请求通知权限</button>
            <button id="sendNotification" onclick="sendTestNotification()" disabled>发送测试通知</button>
            <button id="runDiagnostics" onclick="runDiagnostics()">运行诊断</button>
            <button onclick="clearLog()">清空日志</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            logElement.innerHTML = '';
        }
        
        function updateStatus() {
            const requestBtn = document.getElementById('requestPermission');
            const sendBtn = document.getElementById('sendNotification');
            
            if (!('Notification' in window)) {
                statusElement.className = 'status error';
                statusElement.textContent = '❌ 浏览器不支持通知API';
                requestBtn.disabled = true;
                sendBtn.disabled = true;
                return;
            }
            
            switch (Notification.permission) {
                case 'granted':
                    statusElement.className = 'status success';
                    statusElement.textContent = '✅ 通知权限已授予';
                    requestBtn.disabled = true;
                    sendBtn.disabled = false;
                    break;
                case 'denied':
                    statusElement.className = 'status error';
                    statusElement.textContent = '❌ 通知权限被拒绝';
                    requestBtn.disabled = true;
                    sendBtn.disabled = true;
                    break;
                default:
                    statusElement.className = 'status warning';
                    statusElement.textContent = '⚠️ 需要请求通知权限';
                    requestBtn.disabled = false;
                    sendBtn.disabled = true;
                    break;
            }
        }
        
        async function requestPermission() {
            log('📝 请求通知权限...');
            
            try {
                const permission = await Notification.requestPermission();
                log(`权限结果: ${permission}`);
                updateStatus();
                
                if (permission === 'granted') {
                    log('✅ 通知权限已授予');
                } else {
                    log('❌ 通知权限被拒绝');
                }
            } catch (error) {
                log(`❌ 请求权限失败: ${error.message}`);
            }
        }
        
        function sendTestNotification() {
            log('🚀 发送测试通知...');
            
            if (Notification.permission !== 'granted') {
                log('❌ 没有通知权限');
                return;
            }
            
            try {
                const notification = new Notification('清晨梦想日记 - 测试', {
                    body: '🌐 这是一个Web端测试通知！如果您看到这条通知，说明功能正常工作。',
                    icon: '/favicon.ico',
                    tag: 'test-notification',
                    requireInteraction: false,
                    silent: false
                });
                
                log('✅ 通知对象已创建');
                
                notification.onshow = () => {
                    log('🎉 通知已显示');
                };
                
                notification.onerror = (error) => {
                    log(`❌ 通知显示错误: ${error}`);
                };
                
                notification.onclose = () => {
                    log('🔒 通知已关闭');
                };
                
                notification.onclick = () => {
                    log('🖱️ 用户点击了通知');
                    window.focus();
                    notification.close();
                };
                
                // 8秒后自动关闭
                setTimeout(() => {
                    notification.close();
                    log('⏰ 通知自动关闭');
                }, 8000);
                
            } catch (error) {
                log(`❌ 创建通知失败: ${error.message}`);
            }
        }
        
        function runDiagnostics() {
            log('🔍 开始运行诊断...');
            
            // 基本信息
            log(`浏览器: ${navigator.userAgent}`);
            log(`协议: ${window.location.protocol}`);
            log(`主机: ${window.location.hostname}`);
            
            // 通知API支持
            if ('Notification' in window) {
                log('✅ 支持Notification API');
                log(`权限状态: ${Notification.permission}`);
            } else {
                log('❌ 不支持Notification API');
            }
            
            // 页面状态
            log(`页面可见: ${!document.hidden ? '✅' : '❌'}`);
            log(`页面焦点: ${document.hasFocus() ? '✅' : '❌'}`);
            
            // Service Worker支持
            if ('serviceWorker' in navigator) {
                log('✅ 支持Service Worker');
            } else {
                log('❌ 不支持Service Worker');
            }
            
            // HTTPS检查
            if (window.location.protocol === 'https:' || 
                window.location.hostname === 'localhost' || 
                window.location.hostname === '127.0.0.1') {
                log('✅ 协议检查通过');
            } else {
                log('⚠️ 建议使用HTTPS或localhost');
            }
            
            log('🔍 诊断完成');
        }
        
        // 页面加载时初始化
        window.onload = function() {
            log('🌐 页面加载完成');
            updateStatus();
            
            // 监听页面可见性变化
            document.addEventListener('visibilitychange', () => {
                log(`页面可见性变化: ${document.hidden ? '隐藏' : '显示'}`);
            });
            
            // 监听焦点变化
            window.addEventListener('focus', () => {
                log('窗口获得焦点');
            });
            
            window.addEventListener('blur', () => {
                log('窗口失去焦点');
            });
        };
    </script>
</body>
</html>